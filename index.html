<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUFT Bus Tracker</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Outfit', sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        .ghost-bus img { filter: grayscale(100%) opacity(0.5); }

        .dashboard {
            position: absolute; top: 20px; right: 20px;
            width: 260px; background: #ffffff; padding: 15px;
            border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column; align-items: center;
        }
        .header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .live-badge { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        h2 { margin: 0; color: #0f172a; font-size: 18px; font-weight: 800; }
        #status-text { font-size: 13px; color: #64748b; font-weight: 600; background: #f1f5f9; padding: 6px 12px; border-radius: 15px; margin-top: 4px; text-align: center; line-height: 1.4; }
        .loc-btn { margin-top: 10px; width: 100%; padding: 10px; background: #2563eb; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }

        .menu-btn { position: absolute; top: 20px; left: 20px; background: white; border: none; padding: 12px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; z-index: 1001; }
        .sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: white; z-index: 9999; transition: left 0.3s ease; box-shadow: 5px 0 25px rgba(0,0,0,0.1); padding: 20px; overflow-y: auto; }
        .sidebar.open { left: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        
        .bus-list-item { padding: 12px; margin-bottom: 8px; background: #f8fafc; border-radius: 10px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .bus-list-item:hover { background: #e2e8f0; }
        .bus-name { font-weight: 600; color: #334155; font-size: 14px; }
        .right-group { display: flex; align-items: center; gap: 8px; }
        .mini-link { font-size: 11px; color: #3b82f6; text-decoration: none; font-weight: 700; }
        .mini-link:hover { text-decoration: underline; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        
        #night-notice-sidebar { display: none; background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; margin-bottom: 15px; text-align: center; }
        .floating-notice { display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(254, 226, 226, 0.95); border: 2px solid #ef4444; color: #991b1b; padding: 12px 20px; border-radius: 50px; font-weight: 700; font-size: 13px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 2000; text-align: center; white-space: nowrap; animation: pop-up 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-up { from { transform: translateX(-50%) scale(0.8); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }

        /* POPUP STYLING - REFINED */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .popup-header { color: white; padding: 12px 15px; font-weight: 800; font-size: 15px; }
        .popup-body { padding: 15px; background: white; font-family: 'Outfit', sans-serif; }
        .info-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; color: #334155; }
        .info-icon { width: 22px; text-align: center; margin-right: 8px; font-size: 14px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .track-link { display: block; margin-top: 12px; text-align: center; background: #e2e8f0; color: #0f172a; padding: 10px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 12px; transition: background 0.2s; }
        
        .bus-icon-wrapper { position: relative; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; } 
        .bus-img-top { width: 34px; height: 60px; transition: transform 0.5s linear; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        .about-toggle-btn { margin-top: 15px; background: #f8fafc; color: #334155; font-weight: 600; font-size: 14px; border: 1px solid #e2e8f0; }
        .about-content { display: none; margin-top: 10px; padding: 15px; background: #f1f5f9; border-radius: 8px; font-size: 13px; color: #475569; line-height: 1.6; }
        .about-title { font-weight: 700; color: #0f172a; margin-bottom: 8px; font-size: 15px; }
        .about-limit { margin-top: 12px; font-weight: 600; color: #ef4444; font-size: 13px; }
        .about-credits { margin-top: 15px; font-size: 12px; color: #64748b; font-weight: 500; border-top: 1px solid #cbd5e1; padding-top: 10px; }
        .visitor-text { font-size: 11px; color: #94a3b8; margin-top: 5px; font-weight: 600; }
        .new-feature-list { list-style: none; padding: 0; margin: 5px 0; }
        .new-feature-list li { padding-left: 20px; position: relative; margin-bottom: 6px; font-size: 12px; line-height: 1.4; }
        .new-feature-list li:before { content: '‚ú®'; position: absolute; left: 0; top: 0; }
    </style>
</head>
<body>
    <div id="floating-night-notice" class="floating-notice">üåô Service Paused (Night) - Resumes 6:30 AM Morning</div>
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 20px;">üöç Bus List</h2>
            <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        </div>
        <div id="night-notice-sidebar">üåô <b>Service Paused</b><br>Server is offline from 9:30 PM to 5 AM.</div>
        <div id="bus-list-container"></div>
        <div class="bus-list-item" style="margin-top: 15px; background: #e0f2fe; border: 1px solid #bae6fd;" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSdVfOC1bZcv20mZT5X52iGHORek0H8XPV-3HNhmwrcPr1O6_w/viewform?usp=header', '_blank')"><b>üí¨ Give Feedback</b></div>
        
        <div class="bus-list-item about-toggle-btn" onclick="toggleAbout()">‚ÑπÔ∏è About</div>
        <div id="about-box" class="about-content">
            <div class="about-title">BUFT Unified Bus Tracker <span style="font-size:12px; background:#2563eb; color:white; padding:2px 6px; border-radius:4px; vertical-align:middle;">v2.3</span></div>
            <p style="margin: 0 0 10px 0;">A comprehensive student-led idea designed to modernize University transportation.</p>
            
            <div class="about-limit" style="color:#0f172a;">Key Features:</div>
            <ul class="new-feature-list">
                <li><b>Real-Time Map Tracking:</b> Instantly see the exact, live location of all university buses on an interactive map.</li>
                <li><b>Route Identification:</b> Easily find which bus is heading to your destination (e.g., Mirpur, Tongi, Azampur, etc.) by tapping the bus icons.</li>
                <li><b>Live Status & Speed:</b> Check if your bus is currently moving, stopped, or inactive, along with its current speed in km/h.</li>
                <li><b>Driver Information:</b> View the assigned driver's name and contact information (if available) directly from the map.</li>
                <li><b>Mobile-Optimized:</b> Designed to work smoothly on your smartphone so you can track your ride while on the go.</li>
            </ul>

            <div class="about-credits">Developed By: <b>Shazzad Hossain Nabil (TE_221)</b> <br>Assisted by: <b>Google Gemini AI</b><div id="visitor-count" class="visitor-text">Total Visitors: ...</div></div>
        </div>
    </div>

    <div id="map"></div>
    <div class="dashboard">
        <div class="header-row"><div class="live-badge"></div><h2>BUFT Shuttle Live</h2></div>
        <div id="status-text">Connecting...</div>
        <button onclick="findUser()" class="loc-btn"><span>üìç</span> Locate Me</button>
    </div>

    <script>
        const map = L.map('map', {zoomControl: false}).setView([23.8741, 90.3992], 12);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'] }).addTo(map);
        const SERVER = "https://bus-server-lr2x.onrender.com"; 

        const BUSES = [
            { name: "Bus 1: Islampur", id: "351072", imei: "863051061903687" },
            { name: "Bus 2: Shia Masjid", id: "351073", imei: "863051061866041" },
            { name: "Bus 3: Azampur", id: "351074", imei: "863051061865993" },
            { name: "Bus 4: Azampur", id: "351075", imei: "863051061875091" },
            { name: "Bus 5: Pubail", id: "351076", imei: "863051061778279" },
            { name: "Bus 6: Girls Hostel", id: "351077", imei: "863051061741285" },
            { name: "Bus 7: Stop", id: "351079", imei: "863051061737937" },
            { name: "Bus 8: Azampur", id: "351080", imei: "863051062003073" },
            { name: "Bus 9: Rampura", id: "351081", imei: "863051062002752" },
            { name: "Bus 10: Azampur", id: "351082", imei: "863051062003610" },
            { name: "Bus 11: Kalshi", id: "351083", imei: "863051061786785" },
            { name: "Bus 12: Tongi", id: "351084", imei: "863051061778220" },
            { name: "Bus 13: Zirani", id: "351085", imei: "863051062002935" },
            { name: "Bus 14: Kamlapur", id: "351086", imei: "863051061866694" },
            { name: "Bus 15: Shibbari", id: "351087", imei: "868184062272516" },
            { name: "Bus 16: Mirpur-10", id: "351088", imei: "863051061741137" },
            { name: "Bus 17: Commerce", id: "351089", imei: "868184062144723" },
            { name: "Bus 18: Pallibiduth", id: "351090", imei: "863051061982632" },
            { name: "Bus 23: Gulistan", id: "351091", imei: "863051062003990" },
            { name: "Bus 24: Mirpur-14", id: "351092", imei: "863051061998133" },
            { name: "Bus 25: Newmarket", id: "351650", imei: "863051061775770" },
            { name: "Bus 26: Shafipur", id: "351093", imei: "863051061778014" },
            { name: "BRTC 01", id: "351094", imei: "863051061867940" },
            { name: "BRTC 02", id: "351095", imei: "863051062002919" },
            { name: "BRTC 03", id: "351096", imei: "863051061786629" },
            { name: "BRTC 04", id: "351097", imei: "863051061998075" }
        ];

        const markers = {}; let userMarker = null;

        const listContainer = document.getElementById('bus-list-container');
        BUSES.forEach(bus => {
            const item = document.createElement('div');
            item.className = 'bus-list-item';
            item.innerHTML = `<div class="bus-name">${bus.name}</div><div class="right-group"><div class="status-dot" id="dot-${bus.id}"></div></div>`;
            item.onclick = () => focusBus(bus.id);
            listContainer.appendChild(item);
        });

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function toggleAbout() { const box = document.getElementById('about-box'); box.style.display = (box.style.display === "block") ? "none" : "block"; }

        function focusBus(id) {
            if (markers[id]) { const marker = markers[id]; map.flyTo(marker.getLatLng(), 15); marker.openPopup(); toggleSidebar(); } 
            else { alert("Bus position not yet found. Please wait."); }
        }

        function getBusSVG(color) {
            return `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 240">
                <rect x="15" y="15" width="70" height="210" rx="12" fill="${color}" stroke="#ffffff" stroke-width="6"/>
                <path d="M 25 15 L 75 15 L 75 22 Q 50 28 25 22 Z" fill="#1e293b"/>
                <path d="M20 35 Q50 20 80 35 L80 60 Q50 50 20 60 Z" fill="#334155"/>
                <rect x="25" y="205" width="50" height="10" rx="2" fill="#334155"/>
                <rect x="30" y="90" width="40" height="30" rx="4" fill="rgba(255,255,255,0.4)"/>
                <rect x="30" y="140" width="40" height="30" rx="4" fill="rgba(255,255,255,0.4)"/>
                <path d="M15 45 L5 40 L5 60 L15 55 Z" fill="${color}" stroke="white" stroke-width="3"/>
                <path d="M85 45 L95 40 L95 60 L85 55 Z" fill="${color}" stroke="white" stroke-width="3"/>
            </svg>`;
        }

        var userIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });

        function findUser() {
            if (!navigator.geolocation) { alert("GPS not supported."); return; }
            const btn = document.querySelector('.loc-btn'); btn.innerHTML = "üì° Locating...";
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude; const lng = position.coords.longitude;
                if (userMarker) userMarker.setLatLng([lat, lng]); else userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map).bindPopup("<b>You</b>").openPopup();
                map.setView([lat, lng], 15); btn.innerHTML = "<span>üìç</span> Locate Me";
            }, () => { alert("Enable location."); btn.innerHTML = "‚ùå Denied"; });
        }

        function fixTime(timeStr) {
            if (!timeStr || timeStr === "--") return "--";
            try {
                const parts = timeStr.split(/[- :]/); 
                if (parts.length < 6) return timeStr;

                let day = parseInt(parts[0]);
                let month = parseInt(parts[1]) - 1; 
                let year = parseInt(parts[2]);
                let hours = parseInt(parts[3]);
                let minutes = parseInt(parts[4]);
                let seconds = parseInt(parts[5]);
                let ampm = parts[6];

                if (ampm === "PM" && hours < 12) hours += 12;
                if (ampm === "AM" && hours === 12) hours = 0;

                let date = new Date(year, month, day, hours, minutes, seconds);
                date.setHours(date.getHours() + 1);

                let h = date.getHours();
                const a = h >= 12 ? 'PM' : 'AM';
                h = h % 12;
                h = h ? h : 12; 
                let m = date.getMinutes().toString().padStart(2, '0');
                let s = date.getSeconds().toString().padStart(2, '0');
                let d = date.getDate().toString().padStart(2, '0');
                let mo = (date.getMonth() + 1).toString().padStart(2, '0');
                let yStr = date.getFullYear();

                return `${d}-${mo}-${yStr} ${h}:${m}:${s} ${a}`;
            } catch(e) {
                return timeStr; 
            }
        }

        async function fetchBus(bus) {
            try {
                const res = await fetch(`${SERVER}/bus-api?id=${bus.id}&imei=${bus.imei}`);
                if (!res.ok) return false;
                const raw = await res.json();
                let data = (typeof raw === 'string') ? new Function("return " + raw)() : raw;

                if (data && data.root && data.root[0] && data.root[0][0]) {
                    const info = data.root[0][0];
                    const lat = parseFloat(info.latitude); const lng = parseFloat(info.longitude);
                    
                    let driverName = "Unknown";
                    let mobileNo = "--";
                    if (info.driver_json) {
                        let dObj = (typeof info.driver_json === 'string') ? JSON.parse(info.driver_json.replace(/'/g, '"')) : info.driver_json;
                        driverName = dObj.name || "Unknown";
                        mobileNo = dObj.mobile_no || "--";
                    }

                    const speed = parseFloat(info.speed) || 0;
                    let busColor = '#22c55e'; 
                    let status = "Running";
                    if (speed < 1) { busColor = '#ef4444'; status = "Stopped"; }
                    if (speed > 40) busColor = '#a855f7'; 

                    let durationText = info.since ? info.since.replace(":", "h ") + "m" : "--";
                    let lastUpdated = fixTime(info.data_inserted_time);
                    let course = parseInt(info.angle) || 0;

                    if (lat > 0) {
                        const popup = `
                            <div class="popup-header" style="background:${busColor}">
                                <span>üöå ${bus.name}</span>
                            </div>
                            <div class="popup-body">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <span class="status-badge" style="background:${speed < 1 ? '#fee2e2' : '#dcfce7'}; color:${busColor};">
                                        ${status}
                                    </span>
                                    <span style="font-size:12px; font-weight:700; color:#64748b;">
                                        ‚è≥ Since ${durationText}
                                    </span>
                                </div>

                                <div class="info-row"><span class="info-icon">üë§</span> <b>${driverName}</b></div>
                                <div class="info-row"><span class="info-icon">üìû</span> <a href="tel:${mobileNo}" style="color:#2563eb; text-decoration:none; font-weight:700;">${mobileNo}</a></div>
                                <div class="info-row"><span class="info-icon">üöÄ</span> <b>${speed} km/h</b></div>
                                <div class="info-row"><span class="info-icon">üìç</span> ${info.location || "Moving..."}</div>

                                <div style="font-size:10px; color:#94a3b8; text-align:right; margin-top:8px; border-top:1px solid #f1f5f9; padding-top:6px;">
                                    Updated: ${lastUpdated}
                                </div>
                                <a href="https://app.bongoiot.com/jsp/quickview.jsp?param=${btoa(bus.id + "&Bus&EN")}" target="_blank" class="track-link">üîó Open Full Live Tracker</a>
                            </div>`;
                        
                        const svgString = getBusSVG(busColor);
                        const busImgSrc = "data:image/svg+xml;base64," + btoa(svgString);

                        const customIcon = L.divIcon({ 
                            className: 'custom-bus-icon', 
                            html: `<div class="bus-icon-wrapper"><img src="${busImgSrc}" class="bus-img-top" id="img-${bus.id}" style="transform: rotate(${course}deg);"></div>`, 
                            iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20] 
                        });

                        if (markers[bus.id]) {
                            markers[bus.id].setLatLng([lat, lng]).setPopupContent(popup).setIcon(customIcon);
                            const img = document.getElementById(`img-${bus.id}`); if(img) img.style.transform = `rotate(${course}deg)`;
                        } else { 
                            markers[bus.id] = L.marker([lat, lng], {icon: customIcon}).addTo(map).bindPopup(popup); 
                        }
                        
                        const dot = document.getElementById(`dot-${bus.id}`); if(dot) dot.classList.add('active');
                        return true;
                    }
                }
            } catch (e) { console.log(e); } return false;
        }

        async function updateFleet() {
            const statusEl = document.getElementById('status-text');
            if (!document.querySelector('.status-dot.active')) { statusEl.innerText = "üì° Scanning Network..."; statusEl.style.color = "#64748b"; }

            let totalActive = 0;
            for (let i = 0; i < BUSES.length; i++) {
                fetchBus(BUSES[i]).then(isActive => {
                    if (isActive) {
                        totalActive++;
                        statusEl.innerText = `‚úÖ Active: ${totalActive} Buses`;
                        statusEl.style.color = "#059669";
                    }
                });
                await new Promise(r => setTimeout(r, 30)); 
            }
            
            checkServerHours();
            setTimeout(updateFleet, 5000); 
        }

        function checkServerHours() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const startNight = 21 * 60 + 30; // 9:30 PM
            const endNight = 5 * 60; // 5:00 AM
            if (currentMinutes >= startNight || currentMinutes < endNight) {
                document.getElementById('floating-night-notice').style.display = 'block';
                document.getElementById('night-notice-sidebar').style.display = 'block';
            } else {
                document.getElementById('floating-night-notice').style.display = 'none';
                document.getElementById('night-notice-sidebar').style.display = 'none';
            }
        }

        // --- 10 SECOND ALARM SYSTEM ---
        let hasAlerted = false;
        setTimeout(() => {
            const activeCount = document.querySelectorAll('.status-dot.active').length;
            if (activeCount === 0 && !hasAlerted) {
                hasAlerted = true;
                console.log("üö® 10s passed with 0 buses. Pinging server alarm...");
                fetch(`${SERVER}/send-alert`).catch(e => console.log("Alarm Error:", e));
            }
        }, 10000); // 10 seconds

        checkServerHours();
        setInterval(checkServerHours, 60000);
        updateFleet();
        fetch("https://api.counterapi.dev/v1/buft-tracker-nabil/view/up").then(res => res.json()).then(data => { const el = document.getElementById('visitor-count'); if(el) el.innerText = `Total Visitors: ${data.count}`; }).catch(e => {});
    </script>
</body>
</html>
