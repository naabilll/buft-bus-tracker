<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUFT Live Tracker</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        #map { height: 100vh; width: 100%; }
        
        .dashboard {
            position: absolute; top: 20px; right: 20px; width: 240px;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            z-index: 1000; border-left: 6px solid #003366;
            backdrop-filter: blur(5px);
        }
        
        .popup-card { min-width: 230px; font-family: 'Segoe UI', sans-serif; }
        .popup-header { 
            background: #003366; color: white; padding: 10px; 
            border-radius: 8px 8px 0 0; font-weight: bold; font-size: 15px;
        }
        .popup-body { 
            padding: 12px; border: 1px solid #eee; border-top: none; 
            border-radius: 0 0 8px 8px; background: white;
        }
        .info-row { margin-bottom: 8px; font-size: 13px; color: #444; display: flex; align-items: center; }
        .icon-space { width: 24px; text-align: center; margin-right: 8px; font-size: 16px; }
        
        .track-btn {
            display: block; margin-top: 10px; padding: 8px; 
            background: #28a745; color: white; text-align: center; 
            text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="dashboard">
        <h2 style="margin:0; color:#003366; font-size:18px;">üéì BUFT Tracker</h2>
        <div id="status-text" style="font-size:13px; color:#555; margin-top:5px;">Connecting to Server...</div>
    </div>

    <script>
        // 1. Initialize Map
        const map = L.map('map').setView([23.8741, 90.3992], 11);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // 2. YOUR PERMANENT RENDER SERVER
        const SERVER = "https://bus-server-lr2x.onrender.com"; 

        const BUSES = [
            { name: "Bus 1: Islampur", id: "344928", imei: "863051061903687" },
            { name: "Bus 2: Shia Masjid", id: "344929", imei: "863051061866041" },
            { name: "Bus 3: Azampur", id: "344930", imei: "863051061865993" },
            { name: "Bus 4: Azampur", id: "344932", imei: "863051061875091" },
            { name: "Bus 5: Pubail", id: "344933", imei: "863051061778279" },
            { name: "Bus 6: Girls Hostel", id: "344934", imei: "863051061741285" },
            { name: "Bus 7: Stop", id: "344935", imei: "863051061737937" },
            { name: "Bus 8: Azampur", id: "344936", imei: "863051062003073" },
            { name: "Bus 9: Rampura", id: "344937", imei: "863051062002752" },
            { name: "Bus 10: Azampur", id: "344938", imei: "863051062003610" },
            { name: "Bus 11: Kalshi", id: "344939", imei: "863051061786785" },
            { name: "Bus 12: Tongi", id: "344940", imei: "863051061778220" },
            { name: "Bus 13: Zirani", id: "344941", imei: "863051062002935" },
            { name: "Bus 14: Kamlapur", id: "344942", imei: "863051061866694" },
            { name: "Bus 15: Shibbari", id: "344943", imei: "868184062272516" },
            { name: "Bus 16: Mirpur-10", id: "344944", imei: "863051061741137" },
            { name: "Bus 17: Commerce", id: "344945", imei: "868184062144723" },
            { name: "Bus 18: Pallibiduth", id: "344946", imei: "863051061982632" },
            { name: "Bus 23: Gulistan", id: "344947", imei: "863051062003990" },
            { name: "Bus 24: Mirpur-14", id: "344948", imei: "863051061998133" },
            { name: "Bus 25: Newmarket", id: "344950", imei: "863051061775770" },
            { name: "Bus 26: Shafipur", id: "344951", imei: "863051061778014" },
            { name: "BRTC 01", id: "344952", imei: "863051061867940" },
            { name: "BRTC 02", id: "344953", imei: "863051062002919" },
            { name: "BRTC 03", id: "344955", imei: "863051061786629" },
            { name: "BRTC 04", id: "344956", imei: "863051061998075" }
        ];

        const markers = {};
        var busSvg = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="40" height="40"><path fill="%23003366" d="M488 128h-8V80c0-26.5-21.5-48-48-48H80C53.5 32 32 53.5 32 80v48h-8c-13.3 0-24 10.7-24 24v112c0 13.3 10.7 24 24 24h8v48c0 35.3 28.7 64 64 64h32c35.3 0 64-28.7 64-64v-8h128v8c0 35.3 28.7 64 64 64h32c35.3 0 64-28.7 64-64v-48h8c13.3 0 24-10.7 24-24V152c0-13.3-10.7-24-24-24z"/><path fill="white" d="M96 80h64v48H96zM192 80h64v48h-64zM288 80h64v48h-64zM384 80h48c8.8 0 16 7.2 16 16v32h-64V80zM96 432c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm320 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/><text x="256" y="320" font-family="Arial, sans-serif" font-size="55" font-weight="bold" fill="white" text-anchor="middle">BUFT</text></svg>`;

        var busIcon = L.icon({
            iconUrl: busSvg,
            iconSize: [45, 45], iconAnchor: [22, 45], popupAnchor: [0, -40]
        });

        async function fetchBus(bus) {
            try {
                const res = await fetch(`${SERVER}/bus-api?id=${bus.id}&imei=${bus.imei}`);
                const raw = await res.json();
                let data = (typeof raw === 'string') ? new Function("return " + raw)() : raw;

                if (data && data.root && data.root[0] && data.root[0][0]) {
                    const info = data.root[0][0];
                    const lat = parseFloat(info.latitude);
                    const lng = parseFloat(info.longitude);
                    let driver = "Unknown";
                    let mobile = "N/A";
                    if (info.driver_json) {
                        driver = info.driver_json.name || "Unknown";
                        mobile = info.driver_json.mobile_no || "N/A";
                    }

                    const rawString = bus.id + "&Bus&EN";
                    const encodedParam = btoa(rawString);
                    const liveLink = `https://app.bongoiot.com/jsp/quickview.jsp?param=${encodedParam}`;

                    if (lat > 0) {
                        const popup = `
                            <div class="popup-card">
                                <div class="popup-header">üöå ${bus.name}</div>
                                <div class="popup-body">
                                    <div class="info-row"><span class="icon-space">üëÆ</span> <b>${driver}</b></div>
                                    <div class="info-row"><span class="icon-space">üìû</span> ${mobile}</div>
                                    <div class="info-row"><span class="icon-space">üìç</span> ${info.location || "Moving..."}</div>
                                    <div class="info-row" style="color:#28a745; font-weight:bold;"><span class="icon-space">üöÄ</span> ${info.speed} km/h</div>
                                    <a href="${liveLink}" target="_blank" class="track-btn">üîó Open Live Tracker</a>
                                </div>
                            </div>
                        `;

                        if (markers[bus.id]) {
                            markers[bus.id].setLatLng([lat, lng]).setPopupContent(popup);
                        } else {
                            markers[bus.id] = L.marker([lat, lng], {icon: busIcon}).addTo(map).bindPopup(popup);
                        }
                        return true;
                    }
                }
            } catch (e) { console.error(bus.name + " error"); }
            return false;
        }

        async function updateFleet() {
            document.getElementById('status-text').innerText = "üîÑ Updating...";
            let count = 0;
            // Load 3 buses at a time to be faster but safe
            for (let i = 0; i < BUSES.length; i++) {
                await new Promise(r => setTimeout(r, 100)); 
                const success = await fetchBus(BUSES[i]);
                if (success) count++;
                document.getElementById('status-text').innerText = `‚úÖ Found: ${count} Buses`;
            }
        }

        updateFleet();
        setInterval(updateFleet, 20000);
    </script>
</body>
</html>
