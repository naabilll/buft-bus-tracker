<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUFT Shuttle Live</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Outfit', sans-serif; background: #f0f2f5; overflow: hidden; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- DASHBOARD --- */
        .dashboard {
            position: absolute; top: 20px; right: 20px;
            width: 260px; background: #ffffff; padding: 15px;
            border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column; align-items: center;
        }

        .header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .live-badge {
            width: 10px; height: 10px; background: #ef4444; border-radius: 50%;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        h2 { margin: 0; color: #0f172a; font-size: 18px; font-weight: 800; }
        
        #status-text { 
            font-size: 13px; color: #64748b; font-weight: 600; 
            background: #f1f5f9; padding: 6px 12px; border-radius: 15px; margin-top: 4px;
            text-align: center; line-height: 1.4;
        }

        .loc-btn {
            margin-top: 10px; width: 100%; padding: 10px;
            background: #2563eb; color: white; border: none; border-radius: 12px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        /* --- SIDEBAR MENU --- */
        .menu-btn {
            position: absolute; top: 20px; left: 20px;
            background: white; border: none; padding: 12px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 20px; cursor: pointer; z-index: 1001;
        }
        
        .sidebar {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: white; z-index: 2000; transition: left 0.3s ease;
            box-shadow: 5px 0 25px rgba(0,0,0,0.1); padding: 20px;
            overflow-y: auto;
        }
        .sidebar.open { left: 0; }
        
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;
        }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        
        .bus-list-item {
            padding: 12px; margin-bottom: 8px; background: #f8fafc;
            border-radius: 10px; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .bus-list-item:hover { background: #e2e8f0; }
        .bus-name { font-weight: 600; color: #334155; font-size: 14px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #22c55e; box-shadow: 0 0 5px #22c55e; }

        /* --- ABOUT & VISITOR STYLES --- */
        .about-toggle-btn {
            margin-top: 15px; background: #f8fafc; color: #334155; 
            font-weight: 600; font-size: 14px; border: 1px solid #e2e8f0;
        }
        .about-content {
            display: none; 
            margin-top: 10px; padding: 15px; background: #f1f5f9; border-radius: 8px;
            font-size: 13px; color: #475569; line-height: 1.6;
        }
        .about-title { font-weight: 700; color: #0f172a; margin-bottom: 8px; font-size: 15px; }
        .about-limit { margin-top: 12px; font-weight: 600; color: #ef4444; font-size: 13px; }
        .about-credits { 
            margin-top: 15px; font-size: 12px; color: #64748b; font-weight: 500; 
            border-top: 1px solid #cbd5e1; padding-top: 10px;
        }
        .visitor-text {
            font-size: 11px; color: #94a3b8; margin-top: 5px; font-weight: 600;
        }

        /* --- POPUP STYLE --- */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        .popup-header { background: #003366; color: white; padding: 12px; font-weight: 700; font-size: 15px; }
        .popup-body { padding: 15px; background: white; }
        .track-link {
            display: block; margin-top: 10px; text-align: center;
            background: #e2e8f0; color: #0f172a; padding: 8px; 
            border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 12px;
        }

        /* --- ROTATING BUS ICON STYLE --- */
        .bus-icon-wrapper {
            position: relative;
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .bus-img-top {
            width: 22px; height: 48px;
            transition: transform 0.5s linear; /* Smooth rotation */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 20px;">üöç Bus List</h2>
            <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        </div>
        <div id="bus-list-container"></div>
        
        <div class="bus-list-item" style="margin-top: 15px; background: #e0f2fe; border: 1px solid #bae6fd;" 
             onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSdVfOC1bZcv20mZT5X52iGHORek0H8XPV-3HNhmwrcPr1O6_w/viewform?usp=header', '_blank')">
            <b>üí¨ Give Feedback</b>
        </div>

        <div class="bus-list-item about-toggle-btn" onclick="toggleAbout()">
            ‚ÑπÔ∏è About Project
        </div>

        <div id="about-box" class="about-content">
            <div class="about-title">BUFT Unified Bus Tracker</div>
            <p style="margin: 0 0 10px 0;">
                The BUFT Unified Bus Tracker is a comprehensive, student-led platform designed to modernize university transportation. 
                By aggregating real-time GPS data, we aim to replace manual tracking system with a digital solution with convenience for the entire campus community.
            </p>
            
            <div class="about-limit">‚ö†Ô∏è System Limitations:</div>
            <ul style="padding-left: 15px; margin: 5px 0; font-size: 12px;">
                <li><b>Startup:</b> ~1 min delay if server is sleeping.</li>
                <li><b>Quota:</b> Occasional lags due to free-tier hosting.</li>
                <li><b>Heading:</b> Bus direction arrows are approximate.</li>
            </ul>

            <div class="about-credits">
                Developed by: <b>Shazzad Hossain Nabil (TE 221)</b> <br>
                Assisted by: <b>Google Gemini AI</b>
                
                <div id="visitor-count" class="visitor-text">Total Visitors: ...</div>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <div class="dashboard">
        <div class="header-row">
            <div class="live-badge"></div>
            <h2>BUFT Shuttle Live</h2>
        </div>
        <div id="status-text">Connecting...</div>
        <button onclick="findUser()" class="loc-btn"><span>üìç</span> Locate Me</button>
    </div>

    <script>
        // 1. SETUP MAP
        const map = L.map('map', {zoomControl: false}).setView([23.8741, 90.3992], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
        }).addTo(map);

        const SERVER = "https://bus-server-lr2x.onrender.com"; 

        const BUSES = [
            { name: "Bus 1: Islampur", id: "344928", imei: "863051061903687" },
            { name: "Bus 2: Shia Masjid", id: "344929", imei: "863051061866041" },
            { name: "Bus 3: Azampur", id: "344930", imei: "863051061865993" },
            { name: "Bus 4: Azampur", id: "344932", imei: "863051061875091" },
            { name: "Bus 5: Pubail", id: "344933", imei: "863051061778279" },
            { name: "Bus 6: Girls Hostel", id: "344934", imei: "863051061741285" },
            { name: "Bus 7: Stop", id: "344935", imei: "863051061737937" },
            { name: "Bus 8: Azampur", id: "344936", imei: "863051062003073" },
            { name: "Bus 9: Rampura", id: "344937", imei: "863051062002752" },
            { name: "Bus 10: Azampur", id: "344938", imei: "863051062003610" },
            { name: "Bus 11: Kalshi", id: "344939", imei: "863051061786785" },
            { name: "Bus 12: Tongi", id: "344940", imei: "863051061778220" },
            { name: "Bus 13: Zirani", id: "344941", imei: "863051062002935" },
            { name: "Bus 14: Kamlapur", id: "344942", imei: "863051061866694" },
            { name: "Bus 15: Shibbari", id: "344943", imei: "868184062272516" },
            { name: "Bus 16: Mirpur-10", id: "344944", imei: "863051061741137" },
            { name: "Bus 17: Commerce", id: "344945", imei: "868184062144723" },
            { name: "Bus 18: Pallibiduth", id: "344946", imei: "863051061982632" },
            { name: "Bus 23: Gulistan", id: "344947", imei: "863051062003990" },
            { name: "Bus 24: Mirpur-14", id: "344948", imei: "863051061998133" },
            { name: "Bus 25: Newmarket", id: "344950", imei: "863051061775770" },
            { name: "Bus 26: Shafipur", id: "344951", imei: "863051061778014" },
            { name: "BRTC 01", id: "344952", imei: "863051061867940" },
            { name: "BRTC 02", id: "344953", imei: "863051062002919" },
            { name: "BRTC 03", id: "344955", imei: "863051061786629" },
            { name: "BRTC 04", id: "344956", imei: "863051061998075" }
        ];

        const markers = {};
        const busAngles = {}; 
        let userMarker = null;

        // Populate Sidebar
        const listContainer = document.getElementById('bus-list-container');
        BUSES.forEach(bus => {
            const item = document.createElement('div');
            item.className = 'bus-list-item';
            item.innerHTML = `
                <div class="bus-name">${bus.name}</div>
                <div class="status-dot" id="dot-${bus.id}"></div>
            `;
            item.onclick = () => focusBus(bus.id);
            listContainer.appendChild(item);
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleAbout() {
            const box = document.getElementById('about-box');
            if (box.style.display === "block") {
                box.style.display = "none";
            } else {
                box.style.display = "block";
            }
        }

        function focusBus(id) {
            if (markers[id]) {
                const marker = markers[id];
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
                toggleSidebar();
            } else {
                alert("Bus position not yet found. Please wait.");
            }
        }

        // --- NEW: TOP-DOWN BUS ICON ---
        const topDownBusSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 240"><rect x="10" y="10" width="80" height="220" rx="15" fill="#003366" stroke="#ffffff" stroke-width="5"/><path d="M15 30 L85 30 L85 60 L15 60 Z" fill="#4dabf7"/><circle cx="20" cy="220" r="4" fill="#ef4444"/><circle cx="80" cy="220" r="4" fill="#ef4444"/><path d="M10 180 L90 180" stroke="#ffffff" stroke-width="2" stroke-dasharray="5,5"/></svg>`;
        const busImgSrc = "data:image/svg+xml;base64," + btoa(topDownBusSvg);

        var userIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
        });

        function findUser() {
            if (!navigator.geolocation) { alert("GPS not supported."); return; }
            const btn = document.querySelector('.loc-btn');
            btn.innerHTML = "üì° Locating...";
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                if (userMarker) userMarker.setLatLng([lat, lng]);
                else userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map).bindPopup("<b>You</b>").openPopup();
                map.setView([lat, lng], 15);
                btn.innerHTML = "<span>üìç</span> Locate Me";
            }, () => { alert("Enable location."); btn.innerHTML = "‚ùå Denied"; });
        }

        // --- MATH: Calculate Bearing ---
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const y = Math.sin(lng2 - lng1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                    Math.sin(lat1) * Math.cos(lat2) * Math.cos(lng2 - lng1);
            const theta = Math.atan2(y, x);
            return (theta * 180 / Math.PI + 360) % 360; 
        }
        function toRad(deg) { return deg * Math.PI / 180; }

        async function fetchBus(bus) {
            try {
                const res = await fetch(`${SERVER}/bus-api?id=${bus.id}&imei=${bus.imei}`);
                if (!res.ok) return false;
                const raw = await res.json();
                let data = (typeof raw === 'string') ? new Function("return " + raw)() : raw;

                if (data && data.root && data.root[0] && data.root[0][0]) {
                    const info = data.root[0][0];
                    const lat = parseFloat(info.latitude);
                    const lng = parseFloat(info.longitude);
                    let driver = info.driver_json ? (info.driver_json.name || "Unknown") : "Unknown";
                    let mobile = info.driver_json ? (info.driver_json.mobile_no || "--") : "--";
                    
                    // SMART DIRECTION
                    let course = 0;
                    if (markers[bus.id]) {
                        const oldPos = markers[bus.id].getLatLng();
                        if (oldPos.lat !== lat || oldPos.lng !== lng) {
                            course = calculateBearing(toRad(oldPos.lat), toRad(oldPos.lng), toRad(lat), toRad(lng));
                            busAngles[bus.id] = course;
                        } else {
                            course = busAngles[bus.id] || 0;
                        }
                    } else {
                        course = 0; 
                        busAngles[bus.id] = 0;
                    }

                    const liveLink = `https://app.bongoiot.com/jsp/quickview.jsp?param=${btoa(bus.id + "&Bus&EN")}`;

                    if (lat > 0) {
                        const popup = `
                            <div class="popup-header">üöå ${bus.name}</div>
                            <div class="popup-body">
                                <div style="margin-bottom:5px">üë§ <b>${driver}</b></div>
                                <div style="margin-bottom:5px">üìû ${mobile}</div>
                                <div style="margin-bottom:5px">üìç ${info.location || "Moving..."}</div>
                                <div style="color:#22c55e; font-weight:bold;">üöÄ ${info.speed} km/h</div>
                                <a href="${liveLink}" target="_blank" class="track-link">üîó Open Full Tracker</a>
                            </div>
                        `;

                        const customIcon = L.divIcon({
                            className: 'custom-bus-icon',
                            html: `
                                <div class="bus-icon-wrapper">
                                    <img src="${busImgSrc}" class="bus-img-top" id="img-${bus.id}" style="transform: rotate(${course}deg);">
                                </div>
                            `,
                            iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20]
                        });

                        if (markers[bus.id]) {
                            markers[bus.id].setLatLng([lat, lng]).setPopupContent(popup);
                            const img = document.getElementById(`img-${bus.id}`);
                            if(img) img.style.transform = `rotate(${course}deg)`;
                        } else {
                            markers[bus.id] = L.marker([lat, lng], {icon: customIcon}).addTo(map).bindPopup(popup);
                        }
                        
                        const dot = document.getElementById(`dot-${bus.id}`);
                        if(dot) dot.classList.add('active');
                        return true;
                    }
                }
            } catch (e) { }
            return false;
        }

        // --- WAKE UP LOGIC ---
        async function updateFleet() {
            const statusEl = document.getElementById('status-text');
            statusEl.innerText = "üì° Scanning Network...";
            statusEl.style.color = "#64748b";

            const wakeUpTimer = setTimeout(() => {
                if (statusEl.innerText.includes("Scanning")) {
                    statusEl.innerText = "üí§ Waking up Server... (Wait ~1 min)";
                    statusEl.style.color = "#d97706"; // Orange
                }
            }, 6000);

            let count = 0;
            const BATCH_SIZE = 5; 
            for (let i = 0; i < BUSES.length; i += BATCH_SIZE) {
                const batch = BUSES.slice(i, i + BATCH_SIZE);
                const results = await Promise.all(batch.map(bus => fetchBus(bus)));
                count += results.filter(r => r).length;
                if(count > 0) {
                    clearTimeout(wakeUpTimer);
                    statusEl.innerText = `‚úÖ Active: ${count} Buses`;
                    statusEl.style.color = "#059669"; // Green
                }
            }
            setTimeout(updateFleet, 10000); 
        }

        // --- VISITOR COUNTER LOGIC (UPDATED LOCATION) ---
        function updateVisitorCount() {
            // Using a unique namespace for your project
            fetch("https://api.counterapi.dev/v1/buft-tracker-nabil/view/up")
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById('visitor-count');
                    if(el) el.innerText = `Total Visitors: ${data.count}`;
                })
                .catch(e => console.log("Counter Error:", e));
        }

        updateFleet();
        updateVisitorCount();
    </script>
</body>
</html>

