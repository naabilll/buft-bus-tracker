<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUFT Shuttle Live</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Outfit', sans-serif; background: #f0f2f5; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- DASHBOARD: SMALLER & RIGHT-ALIGNED --- */
        .dashboard {
            position: absolute; 
            top: 20px; 
            right: 20px; /* MOVED TO RIGHT */
            width: 280px; /* MADE SMALLER (was 360px) */
            background: #ffffff; 
            padding: 15px; /* REDUCED PADDING */
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* HEADER & ANIMATION */
        .header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        
        .live-badge {
            width: 10px; height: 10px; background: #ef4444; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        h2 { margin: 0; color: #0f172a; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        
        #status-text { 
            font-size: 13px; color: #64748b; font-weight: 600; 
            background: #f1f5f9; padding: 4px 12px; border-radius: 15px; margin-top: 4px;
        }

        /* --- LOCATE BUTTON --- */
        .loc-btn {
            margin-top: 12px; width: 100%; padding: 10px;
            background: #2563eb; color: white; border: none; border-radius: 12px;
            font-weight: 700; font-size: 14px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s, background 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .loc-btn:active { transform: scale(0.96); }
        .loc-btn:hover { background: #1d4ed8; }

        /* --- POPUP STYLE --- */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        
        .popup-header { background: #003366; color: white; padding: 12px; font-weight: 700; font-size: 15px; }
        .popup-body { padding: 15px; background: white; }
        .info-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 13px; color: #334155; }
        
        .track-link {
            display: block; margin-top: 10px; text-align: center;
            background: #e2e8f0; color: #0f172a; padding: 8px; 
            border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="dashboard">
        <div class="header-row">
            <div class="live-badge"></div>
            <h2>BUFT Shuttle Live</h2>
        </div>
        <div id="status-text">Connecting...</div>
        
        <button onclick="findUser()" class="loc-btn">
            <span>üìç</span> Locate Me
        </button>
    </div>

    <script>
        // 1. SETUP MAP
        const map = L.map('map', {zoomControl: false}).setView([23.8741, 90.3992], 11);
        L.control.zoom({position: 'bottomleft'}).addTo(map); // Moved zoom to bottom LEFT to avoid overlap
        
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // 2. YOUR SERVER
        const SERVER = "https://bus-server-lr2x.onrender.com"; 

        const BUSES = [
            { name: "Bus 1: Islampur", id: "344928", imei: "863051061903687" },
            { name: "Bus 2: Shia Masjid", id: "344929", imei: "863051061866041" },
            { name: "Bus 3: Azampur", id: "344930", imei: "863051061865993" },
            { name: "Bus 4: Azampur", id: "344932", imei: "863051061875091" },
            { name: "Bus 5: Pubail", id: "344933", imei: "863051061778279" },
            { name: "Bus 6: Girls Hostel", id: "344934", imei: "863051061741285" },
            { name: "Bus 7: Stop", id: "344935", imei: "863051061737937" },
            { name: "Bus 8: Azampur", id: "344936", imei: "863051062003073" },
            { name: "Bus 9: Rampura", id: "344937", imei: "863051062002752" },
            { name: "Bus 10: Azampur", id: "344938", imei: "863051062003610" },
            { name: "Bus 11: Kalshi", id: "344939", imei: "863051061786785" },
            { name: "Bus 12: Tongi", id: "344940", imei: "863051061778220" },
            { name: "Bus 13: Zirani", id: "344941", imei: "863051062002935" },
            { name: "Bus 14: Kamlapur", id: "344942", imei: "863051061866694" },
            { name: "Bus 15: Shibbari", id: "344943", imei: "868184062272516" },
            { name: "Bus 16: Mirpur-10", id: "344944", imei: "863051061741137" },
            { name: "Bus 17: Commerce", id: "344945", imei: "868184062144723" },
            { name: "Bus 18: Pallibiduth", id: "344946", imei: "863051061982632" },
            { name: "Bus 23: Gulistan", id: "344947", imei: "863051062003990" },
            { name: "Bus 24: Mirpur-14", id: "344948", imei: "863051061998133" },
            { name: "Bus 25: Newmarket", id: "344950", imei: "863051061775770" },
            { name: "Bus 26: Shafipur", id: "344951", imei: "863051061778014" },
            { name: "BRTC 01", id: "344952", imei: "863051061867940" },
            { name: "BRTC 02", id: "344953", imei: "863051062002919" },
            { name: "BRTC 03", id: "344955", imei: "863051061786629" },
            { name: "BRTC 04", id: "344956", imei: "863051061998075" }
        ];

        const markers = {};
        let userMarker = null;

        var busSvg = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="40" height="40"><path fill="%23003366" d="M488 128h-8V80c0-26.5-21.5-48-48-48H80C53.5 32 32 53.5 32 80v48h-8c-13.3 0-24 10.7-24 24v112c0 13.3 10.7 24 24 24h8v48c0 35.3 28.7 64 64 64h32c35.3 0 64-28.7 64-64v-8h128v8c0 35.3 28.7 64 64 64h32c35.3 0 64-28.7 64-64v-48h8c13.3 0 24-10.7 24-24V152c0-13.3-10.7-24-24-24z"/><path fill="white" d="M96 80h64v48H96zM192 80h64v48h-64zM288 80h64v48h-64zM384 80h48c8.8 0 16 7.2 16 16v32h-64V80zM96 432c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm320 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/><text x="256" y="320" font-family="Arial, sans-serif" font-size="55" font-weight="bold" fill="white" text-anchor="middle">BUFT</text></svg>`;

        var busIcon = L.icon({
            iconUrl: busSvg,
            iconSize: [45, 45], iconAnchor: [22, 45], popupAnchor: [0, -40]
        });

        var userIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        function findUser() {
            if (!navigator.geolocation) { alert("GPS not supported."); return; }
            const btn = document.querySelector('.loc-btn');
            btn.innerHTML = "üì° Locating...";
            
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                if (userMarker) userMarker.setLatLng([lat, lng]);
                else userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map).bindPopup("<b>You</b>").openPopup();
                map.setView([lat, lng], 15);
                btn.innerHTML = "<span>üìç</span> Locate Me";
            }, () => { 
                alert("Please enable location."); 
                btn.innerHTML = "‚ùå Denied";
            });
        }

        async function fetchBus(bus) {
            try {
                const res = await fetch(`${SERVER}/bus-api?id=${bus.id}&imei=${bus.imei}`);
                if (!res.ok) return false;
                
                const raw = await res.json();
                let data = (typeof raw === 'string') ? new Function("return " + raw)() : raw;

                if (data && data.root && data.root[0] && data.root[0][0]) {
                    const info = data.root[0][0];
                    const lat = parseFloat(info.latitude);
                    const lng = parseFloat(info.longitude);
                    let driver = info.driver_json ? (info.driver_json.name || "Unknown") : "Unknown";
                    let mobile = info.driver_json ? (info.driver_json.mobile_no || "--") : "--";
                    const liveLink = `https://app.bongoiot.com/jsp/quickview.jsp?param=${btoa(bus.id + "&Bus&EN")}`;

                    if (lat > 0) {
                        const popup = `
                            <div class="popup-header">üöå ${bus.name}</div>
                            <div class="popup-body">
                                <div class="info-row"><span>üë§</span> <b>${driver}</b></div>
                                <div class="info-row"><span>üìû</span> ${mobile}</div>
                                <div class="info-row"><span>üìç</span> ${info.location || "Moving..."}</div>
                                <div class="info-row" style="color:#22c55e; font-weight:bold;"><span>üöÄ</span> ${info.speed} km/h</div>
                                <a href="${liveLink}" target="_blank" class="track-link">üîó Open Full Tracker</a>
                            </div>
                        `;

                        if (markers[bus.id]) {
                            markers[bus.id].setLatLng([lat, lng]).setPopupContent(popup);
                        } else {
                            markers[bus.id] = L.marker([lat, lng], {icon: busIcon}).addTo(map).bindPopup(popup);
                        }
                        return true;
                    }
                }
            } catch (e) { }
            return false;
        }

        async function updateFleet() {
            document.getElementById('status-text').innerText = "üì° Scanning Network...";
            let count = 0;
            const BATCH_SIZE = 5; 
            for (let i = 0; i < BUSES.length; i += BATCH_SIZE) {
                const batch = BUSES.slice(i, i + BATCH_SIZE);
                const results = await Promise.all(batch.map(bus => fetchBus(bus)));
                count += results.filter(r => r).length;
                if(count > 0) document.getElementById('status-text').innerText = `‚úÖ Active Fleet: ${count} Buses`;
            }
            setTimeout(updateFleet, 10000); 
        }

        updateFleet();
    </script>
</body>
</html>
